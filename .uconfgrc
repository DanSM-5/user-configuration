#!/usr/bin/env bash

######################################
#        GENERAL CONFIGURATION       #
######################################

# Follow structure conf folders and files
user_conf_path="$HOME/.usr_conf"
user_scripts_path="$HOME/user-scripts"
prj="$HOME/prj"

backup_path () {
  export PATH_BACKUP=$(echo -n $PATH | tr ":" "\n")
}

# Separate path entries that start with /mnt/
set_windows_path () {
  export WIN_PATH=$(echo -n $PATH_BACKUP | rg "/mnt/" | sed ':a; N; $!ba; s/\n/:/g')
}

set_unix_path () {
  export UNIX_PATH=$(echo -n $PATH_BACKUP | rg "/mnt/" --invert-match | sed ':a; N; $!ba; s/\n/:/g')
}

set_path () {
  export PATH="$1"
}

path_append ()  { path_remove $1; export PATH="$PATH:$1"; }
path_prepend () { path_remove $1; export PATH="$1:$PATH"; }
path_remove ()  { export PATH=`echo -n $PATH | awk -v RS=: -v ORS=: '$0 != "'$1'"' | sed 's/:$//'`; }

detect_shell () {
  # echo "Loading..."
  # echo "Running from shell: $SHELL"

  if [ -n "$ZSH_VERSION" ]; then
    export IS_ZSH=true
    export IS_BASH=false
    export SHELL_NAME=zsh
    test -f "$user_conf_path/.zsh_conf" && source "$user_conf_path/.zsh_conf"

  elif [ -n "$BASH_VERSION" ]; then
    export IS_ZSH=false
    export IS_BASH=true
    export SHELL_NAME=bash
    test -f "$user_conf_path/.bash_conf" && source "$user_conf_path/.bash_conf"

  else
    echo "[WARNING]: NO VALID CONFIGURATION DETECTED!"
    export IS_ZSH=false
    export IS_BAHS=false
    export SHELL_NAME=unknown

  fi
}

set_linux () {
  # export IS_LINUX=true
  if command_exists "/home/linuxbrew/.linuxbrew/bin/brew"; then
    # Linux brew
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

    local brew_nvm=$(brew --prefix nvm)
  fi

  # NVM configuration (Bash only)
  if [ "$IS_BASH" = "true" ]; then
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
    [ -s "$brew_nvm/etc/bash_completion.d/nvm" ] && \. "$brew_nvm/etc/bash_completion.d/nvm"  # This loads nvm bash_completion from brew
  fi

  # Set color for hints
  export LS_COLORS='rs=0:di=01;93:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.webp=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:'

  # Setup wsl specifics
  if [ "$IS_WSL" = true ]; then
    set_wsl
  fi
}

set_wsl () {
  # Windows file system
  export WIN_ROOT="/mnt/c"
}

set_gitbash () {
  # Load fzf-git
  [ -f "$HOME/.usr_conf/utils/fzf-git.sh" ] && source "$HOME/.usr_conf/utils/fzf-git.sh"

  export MSYS="$MSYS winsymlinks:nativestrict"

  [ "$IS_ZSH" = true ] && fpath=(~/.zsh $fpath)
  # Load fzf helpers
  # [ -f "$HOME/.fzf.bash" ] && source "$HOME/.fzf.bash"

  # Windows file system
  export WIN_ROOT="/c"
}

set_termux () {
  :
}

set_mac () {
  # export IS_MAC=true
  export BASH_SILENCE_DEPRECATION_WARNING=1
  if command_exists brew; then
    # NVM configuration
    export NVM_DIR="$HOME/.nvm"
    local nvm_path=$(brew --prefix nvm)
    [ -s $nvm_path/nvm.sh ] && source $nvm_path/nvm.sh
    [ -s $nvm_path/etc/bash_completion.d/nvm ] && source $nvm_path/etc/bash_completion.d/nvm
  fi

  # Set color output
  if [ -d "$(brew --prefix coreutils)" ]; then
    test -r ~/.dircolors && eval "$(gdircolors -b ~/.dircolors)" || eval "$(gdircolors -b)"
    alias ls='ls --color=auto'
    alias dir='dir --color=auto'
    alias vdir='vdir --color=auto'
    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
  fi
}



set_general () {
  export EDITOR="$PREFERED_EDITOR"
  export COLORTERM='truecolor'
  export BAT_THEME='Dracula'
  # dark='--color=bg+:#3F3F3F,bg:#4B4B4B,border:#6B6B6B,spinner:#98BC99,hl:#719872,fg:#D9D9D9,header:#719872,info:#BDBB72,pointer:#E12672,marker:#E17899,fg+:#D9D9D9,preview-bg:#3F3F3F,prompt:#98BEDE,hl+:#98BC99'
  # light='--color=bg+:#D9D9D9,bg:#E1E1E1,border:#C8C8C8,spinner:#719899,hl:#719872,fg:#616161,header:#719872,info:#727100,pointer:#E12672,marker:#E17899,fg+:#616161,preview-bg:#D9D9D9,prompt:#0099BD,hl+:#719899'
  local gruvbox='--color="bg+:#3c3836,bg:#32302f,spinner:#fb4934,hl:#928374,fg:#ebdbb2,header:#928374,info:#8ec07c,pointer:#fb4934,marker:#fb4934,fg+:#ebdbb2,prompt:#fb4934,hl+:#fb4934"'
  # nord_vim='--color=bg+:#3B4252,bg:#2E3440,spinner:#81A1C1,hl:#616E88,fg:#D8DEE9,header:#616E88,info:#81A1C1,pointer:#81A1C1,marker:#81A1C1,fg+:#D8DEE9,prompt:#81A1C1,hl+:#81A1C1'
  # molokai='--color=bg+:#293739,bg:#1B1D1E,border:#808080,spinner:#E6DB74,hl:#7E8E91,fg:#F8F8F2,header:#7E8E91,info:#A6E22E,pointer:#A6E22E,marker:#F92672,fg+:#F8F8F2,prompt:#F92672,hl+:#F92672'
  export FZF_DEFAULT_OPTS="--height 80% --layout=reverse --border"

  # enable color support of ls and also add handy aliases
  if [ -x /usr/bin/dircolors ]; then
    test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
    alias ls='ls --color=auto'
    alias dir='dir --color=auto'
    alias vdir='vdir --color=auto'
    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
  fi

  # colored GCC warnings and errors
  #export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'

  # make less more friendly for non-text input files, see lesspipe(1)
  [ -x /usr/bin/lesspipe ] && eval "$(SHELL=/bin/sh lesspipe)"

  # set PATH so it includes user's provate bin if it exists
  # if [ -d "$HOME/bin" ]; then
  export PATH="$HOME/bin:$PATH"
  # fi

  # set PATH so it includes user's provate bin if it exists
  # if [ -d "$HOME/.local/bin" ]; then
  export PATH="$HOME/.local/bin:$PATH"
  # fi

  if [ -d "$HOME/.bun" ]; then
    # bun completions
    [ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"

    # bun
    export BUN_INSTALL="$HOME/.bun"
    export PATH="$BUN_INSTALL/bin:$PATH"
  fi


  # To install useful key bindings and fuzzy completion:
  # $(brew --prefix)/opt/fzf/install # call only once
  # case $SHELL_NAME in
  #   zsh)  test -f ~/.fzf.zsh && source ~/.fzf.zsh;;
  #   bash) test -f ~/.fzf.bash && source ~/.fzf.bash;;
  # esac
}

set_general_after () {
  if command_exists delta; then
    export __git_pager__=delta
  fi

  if [ -f "$HOME/.fzf.$SHELL_NAME" ]; then
    source "$HOME/.usr_conf/utils/fzf-git.sh"
  fi

  if command_exists register-python-argcomplete; then
    eval "$(register-python-argcomplete pipx | tr -d '\r')"
  fi

  if command_exists starship; then
    eval "$(starship init $SHELL_NAME)"
  fi

  # oh-my-posh requires brew
  if command_exists oh-my-posh && test -f ~/omp-theme/jandedobbeleer.omp.v2.json; then
    eval "$(oh-my-posh --init --shell $SHELL_NAME --config ~/omp-theme/jandedobbeleer.omp.v2.json)"
  fi

  export PREFERED_EDITOR='vim'
  if command_exists nvim; then
    export PREFERED_EDITOR='nvim'
  fi

  # For nix package manager
  if command_exists nix-env; then
    # alias nxs="nix-env -qaP '.*$1.*'"
    alias nxl="nix-env -q"
    alias nxi="nix-env -iA"
    alias nxr="nix-env -e"
    alias nxu="nix-env -u"

    nxs () {
      nix-env -qaP ".*$@.*"
    }
  fi

  # For envman. Do not edit.
  [ -s "$HOME/.config/envman/load.sh" ] && source "$HOME/.config/envman/load.sh"

  if command_exists fzf; then
    # CTRL-/ to toggle small preview window to see the full command
    # CTRL-Y to copy the command into clipboard using pbcopy
    export FZF_CTRL_R_OPTS="
      --preview 'echo {}' --preview-window up:3:hidden:wrap
      --bind 'ctrl-/:toggle-preview'
      --bind 'ctrl-s:toggle-sort'
      --bind 'ctrl-y:execute-silent(echo -n {2..} | \$clipboard_copy)+abort'
      --color header:italic
      --header 'Press CTRL-Y to copy command into clipboard'"

    # Print tree structure in the preview window
    export FZF_ALT_C_OPTS="
      --preview 'ls -AF --color=always {-1} 2> /dev/null || echo "'"Cannot access directory {}"'"'
      --bind 'ctrl-/:change-preview-window(down|hidden|),alt-up:preview-page-up,alt-down:preview-page-down,ctrl-s:toggle-sort'"

    export FZF_CTRL_T_OPTS="
      --preview 'if [ -f {} ]; then
          bat -pp --color=always --style=numbers {}
        else
          "'echo "Path: $(realpath {})"'"
          echo ''
          ls -AFL --color=always {}
        fi'
      --bind 'ctrl-/:change-preview-window(down|hidden|),alt-up:preview-page-up,alt-down:preview-page-down,ctrl-s:toggle-sort'"
  fi

  # fzf support
  if command_exists rg; then
    export FZF_DEFAULT_COMMAND='rg --files --follow --no-ignore --hidden --glob "!node_modules" --glob "!.git"'
  fi

  if command_exists fd; then
    export FD_SHOW_OPTIONS=(
      --follow
      --hidden
      --no-ignore
    )

    export FD_EXCLUDE_OPTIONS=(
      --exclude AppData
      --exclude Android
      --exclude node_modules
      --exclude tizen-studio
      --exclude Library
      --exclude scoop
      --exclude vimfiles
      --exclude aws
      --exclude nvim
      --exclude .vscode-server
      --exclude .vscode-server-server
      --exclude .git
      --exclude .gitbook
      --exclude .gradle
      --exclude .nix-defexpr
      --exclude .azure
      --exclude .SpaceVim
      --exclude .cache
      --exclude .node-gyp
      --exclude .npm
      --exclude .nvm
      --exclude .colima
      --exclude .pyenv
      --exclude .DS_Store
      --exclude .vscode
      --exclude .vim
      --exclude .bun
    )

    export FZF_CTRL_T_COMMAND="fd ${FD_SHOW_OPTIONS[@]} ${FD_EXCLUDE_OPTIONS[@]}"
    export FZF_ALT_C_COMMAND="fd --type d ${FD_SHOW_OPTIONS[@]} ${FD_EXCLUDE_OPTIONS[@]}"

    # Use fd (https://github.com/sharkdp/fd) instead of the default find
    # command for listing path candidates.
    _fzf_compgen_path () {
      fd --hidden --follow --exclude "node_modules" --exclude ".git" . "$1"
    }

    # Use fd to generate the list for directory completion
    _fzf_compgen_dir () {
      fd --type d --hidden --follow --exclude "node_modules" --exclude ".git" . "$1"
    }
  fi

  if command_exists rga; then
    rga-fzf () {
      RG_PREFIX="rga --files-with-matches"
      local file
      file="$(
      FZF_DEFAULT_COMMAND="$RG_PREFIX '$1'" \
        fzf --sort --preview="[[ ! -z {} ]] && rga --pretty --context 5 {q} {}" \
        --phony -q "$1" \
        --bind "change:reload:$RG_PREFIX {q}" \
        --preview-window="70%:wrap"
      )" &&
      echo "opening $file" &&
      xdg-open "$file"
    }
  fi

  if command_exists bat; then

    if [ "$IS_TERMUX" = true ]; then
      export MANPAGER="$HOME/.local/bin/manpager-helper"
    else
      # TODO: Investigate manpager-helper not working on WSL
      export MANPAGER="sh -c 'col -bx | bat -l man -p'"
    fi

  fi
}

# initialize shell
detect_shell

# Should be called system agnostic
set_general

# Set device specific
case "$(uname)" in
  Linux*) set_linux;;
  Darwin*) set_mac;;
  *NT*) set_gitbash;;
esac

set_general_after

